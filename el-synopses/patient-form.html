<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/gold-email-input/gold-email-input.html">

<dom-module id="patient-form">
<style>
:host paper-dialog {
  padding: 0 20px;
}

:host .inline paper-input {
  float:left;
}

:host .column {
  margin-right: 10px;
}

.imagecolumn {
  padding: 0 30px 0 10px;
}

textarea[name='sharednotes'] {
  border: none;
  color: red;
  width: 100%;
}
</style>
<template>
  <paper-dialog id="dialog" modal>
    <h2>{{ title }}</h2>
    <form is="iron-form" id="patientform" method="post">
      <paper-dialog-scrollable>
        <div class="horizontal layout">
          <div class="column">
            <paper-input name="first_name" label="First name" required autofocus></paper-input>
            <paper-input name="last_name" label="Last name" required></paper-input>
            <paper-input name="phone1" label="Phone number"></paper-input>
            <paper-input name="phone2" label="Mobile number"></paper-input>
            <paper-input name="policyno" label="Policy number"></paper-input>
            <paper-input-container on-click="_onChangeDropdown">
              <input list="insurance-list" is="core-input" name="insurance">
              <datalist id="insurance-list">
                <!-- Datasource: http://www.priminfo.ch/praemien/index.php?sprache=d -->
                <option value="Agrisano Brugg"></option><option value="AMB Le Châble"></option><option value="Aquilana Baden"></option><option value="Arcosana Luzern"></option><option value="ASSURA Pully"></option><option value="Atupri Bern"></option><option value="Avanex Zürich"></option><option value="Avenir Martigny"></option><option value="BKKE Einsiedeln"></option><option value="CMVEO Orsières"></option><option value="Compact Zürich"></option><option value="CONCORDIA Luzern"></option><option value="CSS Luzern"></option><option value="Easy Sana Martigny"></option><option value="EGK Laufen"></option><option value="GALENOS Zürich"></option><option value="GLKV Elm"></option><option value="Helsana Zürich"></option><option value="indivo Zürich"></option><option value="Intras Luzern"></option><option value="KK Birchmeier Künten"></option><option value="KK Ingenbohl Brunnen"></option><option value="KK Simplon"></option><option value="KK Steffisburg"></option><option value="KK Stoffel Mels"></option><option value="KK Turbenthal"></option><option value="KK Wädenswil"></option><option value="KkLH Zell"></option><option value="KKV Visperterminen"></option><option value="KKZ Zeneggen"></option><option value="KLuG Zug"></option><option value="kmu Winterthur"></option><option value="Kolping Dübendorf"></option><option value="KPT Bern"></option><option value="KVF Bülach"></option><option value="Lumneziana Vella"></option><option value="maxi.ch Zürich"></option><option value="Moove Sympany Basel"></option><option value="Mutuel Martigny"></option><option value="ÖKK Landquart"></option><option value="Philos Martigny"></option><option value="Progrès Zürich"></option><option value="Provita Winterthur"></option><option value="rhenusana Heerbrugg"></option><option value="sana24 Bern"></option><option value="Sanagate Luzern"></option><option value="sanavals Vals"></option><option value="Sanitas Zürich"></option><option value="Sansan Zürich"></option><option value="SLKK Zürich"></option><option value="sodalis Visp"></option><option value="Sumiswalder Sumiswald"></option><option value="SUPRA Lausanne"></option><option value="SWICA Winterthur"></option><option value="Visana Bern"></option><option value="vita surselva Ilanz"></option><option value="vivacare Bern"></option><option value="Vivao Sympany Basel"></option><option value="Wincare Zürich"></option>
              </datalist>
            </paper-input-container>
            <label>Health insurance</label>
          </div><div class="column">
            <gold-email-input name="email" label="Email address" auto-validate></gold-email-input>
            <paper-input name="address1" label="Address"></paper-input>
            <paper-input name="address2" label="Address 2"></paper-input>
            <paper-input name="city" label="City"></paper-input>
            <paper-input name="postal" label="Postal code"></paper-input>
            <paper-input name="socialsecurity" label="AHV number"></paper-input>
            <input type="hidden" name="country" value="Switzerland">
            <!--< paper-input-container on-click="_onChangeDropdown">
              <input list="country-list" is="core-input" name="country">
              <datalist id="country-list">
                <option value="Switzerland"></option>
              </datalist>
            </paper-input-container>
            <label>Country</label>-->
          </div>
        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button raised on-tap="saveDialog">Save</paper-button>
      </div>
    </form>
  </paper-dialog>

  <paper-dialog id="dialogView" modal>
    <paper-dialog-scrollable>
      <div class="horizontal layout">
        <div class="column imagecolumn">
          <form is="ajax-form" id="photoform" method="post" class="fileupload" enctype="multipart/form-data"
                on-submitted="_onSubmitUpload" on-invalid="_onSubmitError">
            <profile-img id="profileimage" item-icon large
                src="{{patient.photo}}" on-tap="_onTapProfileImage"></profile-img>
            <input id="profilefile" type="file" name="file"
                hidden on-change="_onChangePhoto">
          </form>
        </div>
        <div class="column">
          <h2>
            <span>{{patient.first_name}}</span>
            <span>{{patient.last_name}}</span>
          </h2>

          <p style="min-height: 7em;">
            <span>{{patient.address1}}</span>
            <span>{{patient.address2}}</span> |
            <span>{{patient.postal}}</span>
            <span>{{patient.city}}</span> |
            <span>{{patient.country}}</span>
            <br>
            <span>{{patient.phone1}}</span>
            <br>
            <span>{{patient.email}}</span>
            <br>
            <span>{{patient.insurance}}</span>
            <span>{{patient.policyno}}</span>
          </p>

          <h4>Current Cases</h4>
          <template is="dom-repeat" items="[[details.cases]]">
            <span>{{item}}</span><br>
          </template>

          <h4>Notes</h4>
          <form is="iron-form" id="detailsform" method="post">
            <textarea name="sharednotes" on-change="_onChangeNotes">{{patient.sharednotes}}</textarea>
          </form>

        </div><div class="column">
          <h2>&nbsp;</h2>

          <p style="min-height: 7em;">
            Height: <span>{{patient.record.height}}</span> cm |
            Weight: <span>{{patient.record.weight}}</span> kg
            <br>
            Age: <span>{{details.age}}</span> |
            BMI: <span>{{details.bmi}}</span>
            <!--<br>
            Allergies: <span>{{patient.record.allergies}}</span>-->
            <br>
            Blood group: <span>{{patient.record.blood_group}}</span>
          </p>

          <!--<h4>Current Medication</h4>
          <p>Tylenol T4</p>

          <h4>Family History</h4>-->

          <h4>Current Therapists</h4>
          <template is="dom-repeat" items="[[patient.doctors]]">
            <span>{{item}}</span><br>
          </template>

          <h4>Files</h4>
          <template is="dom-repeat" items="[[details.files]]">
            <span>{{item}}</span><br>
          </template>
        </div>
      </div>
    </paper-dialog-scrollable>
    <div class="buttons">
      <paper-button dialog-dismiss>Close</paper-button>
    </div>
  </paper-dialog>
</template>
<script>
  Polymer({
    is: 'patient-form',

    properties: {
      title: {
        value: "Patient file (edit)",
        reflectToAttribute: true
      },

      patient: {
        type: Object,
        value: function() { return {}; },
        reflectToAttribute: false,
        observer: '_patientChanged'
      },

      details: {
        type: Object,
        value: function() { return {}; },
        reflectToAttribute: false
      }
    },

    saveDialog: function(e) {
      if (this.$.patientform.checkValidity()) {
        this.$.patientform.submit();
        this.fire('patient-saved');
        this.$.dialog.close();
        return true;
      } else {
        return false;
      }
    },

    _patientChanged: function() {
      var forms = this.querySelectorAll('form');
      for (var i = 0; i < forms.length; i++) {
        forms[i].action = '/api/patient/' + this.patient.id + '/save';
      }
    },

    _onChangeDropdown: function(e) {
      Polymer.dom(e).localTarget.blur();
    },

    _onChangeNotes: function(e) {
      this.$.detailsform.submit();
    },

    _onTapProfileImage: function() {
      this.$.profilefile.click();
    },

    _onChangeNotes: function(e) {
      this.$.detailsform.submit();
    },

    _onChangePhoto: function(e) {
      this.$.photoform.submit();
    },

    _onSubmitUpload: function(e) {
      var jsondata = JSON.parse(e.detail.response);
      if (jsondata.flag !== 'success') {
        return window.alert(jsondata.msg);
      }
      if (typeof jsondata.filespec !== 'undefined') {
        this.$.profileimage.src = jsondata.filespec;
      }
    },

    _onSubmitError: function(e) {
      window.alert("Error saving profile, please try again");
    }

  });
</script>
</dom-module>
